# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Проект

Browser Agent — тестовое задание для автоматизации браузера через LLM (Polza.ai/OpenAI). Пользователь отправляет текстовую задачу, агент выполняет её в видимом браузере автономно.

## Критические требования (из requements.md)

**ЗАПРЕЩЕНО:**
- Жёсткие инструкции/подсказки в промпте — агент должен сам догадываться о кнопках, ссылках, селекторах
- Заготовки действий для конкретных задач (шаги заказа пиццы и т.п.)
- Хардкод селекторов (например `a[data-qa='vacancy']`)
- Подсказки по ссылкам и элементам (нельзя хардкодить что /vacancies — это страница вакансий)

**ОБЯЗАТЕЛЬНО:**
- Минималистичный системный промпт (только общие принципы, никаких детальных инструкций)
- Хотя бы один продвинутый паттерн: sub-agent, error handling, или security layer
- Модель с vision-поддержкой (browser-use отправляет скриншоты страницы)

## Запуск

```bash
# Базовый запуск
python main.py "текст задачи"

# С другой моделью
python main.py --model anthropic/claude-sonnet-4 "текст задачи"

# Фоновый режим
python main.py --headless "текст задачи"
```

## Архитектура

### Основные компоненты

**main.py** — точка входа, содержит:
- `SubAgentCoordinator` — координатор с интегрированными энхансерами
- Патч для увеличения лимита информации о странице (150K вместо 40K)
- SECURITY_PROMPT — минималистичный системный промпт

**Энхансеры (интегрированы через register_new_step_callback):**

1. **Security Layer** (`security_layer.py`) — блокирует опасные действия:
   - Блокирует: финальную оплату, новые вкладки
   - НЕ блокирует: add to cart, выбор опций

2. **Modal Enhancer** (`modal_enhancer.py`) — детектирует модальные окна:
   - Ищет: `role="dialog"`, `aria-modal="true"`, классы modal/dialog/popup
   - Логирует найденные модальные окна

3. **Button Hint Helper** (`button_hint_helper.py`) — умный поиск кнопок:
   - Ищет кнопки добавления в корзину БЕЗ хардкода
   - Использует эвристики и контекст

4. **Element Recognition Enhancer** (`element_recognition_enhancer.py`) — распознавание элементов:
   - Распознаёт кнопки-символы (+, -, иконки)
   - Анализирует контекст элементов

## Установка зависимостей

```bash
pip install -r requirements.txt
python -m playwright install chromium
```

## Модели

**По умолчанию:** `openai/gpt-4o` (поддерживает vision)

**Доступные на Polza.ai:**
- `openai/gpt-4o`
- `openai/gpt-4o-mini`
- `anthropic/claude-sonnet-4`

## Persistent sessions

Браузер сохраняет сессию в `~/.browser-agent/profile/`. Пользователь может войти в аккаунт вручную, агент продолжит работу.

## Важные ограничения при разработке

При изменении кода ВСЕГДА помните о требованиях:

1. **НЕ добавляйте жёсткие инструкции в промпт** — агент должен сам догадываться
2. **НЕ хардкодьте селекторы** — используйте эвристики
3. **НЕ создавайте заготовки действий** — агент должен решать автономно
4. **Держите системный промпт минималистичным** — только общие принципы

## Тестовые задачи

```bash
# Поиск информации
python main.py "найди статью про Python на Википедии"

# Покупки
python main.py "зайди на яндекс еду, найди пиццу и добавь в корзину"

# Еда
python main.py "зайди на самокат и добавь сэндвич в корзину"
```
